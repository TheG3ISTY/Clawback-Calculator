<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Commission Clawback Calculator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root { --bg:#0b0c10; --card:#151821; --text:#e8e8e8; --muted:#9aa3b2; --primary:#4f8cff; --danger:#ff5c5c; --border:#222737; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; background:var(--bg); color:var(--text); }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 24px; }
    h1 { font-size: 28px; margin: 0 0 8px; }
    p.muted { color: var(--muted); margin: 0 0 20px; font-size: 14px; }
    .card { background: var(--card); border:1px solid var(--border); border-radius: 12px; padding: 16px; margin: 16px 0; }
    .grid { display:grid; gap:12px; }
    @media (min-width: 860px) { .grid-2 { grid-template-columns: 1fr 1fr; } }
    label { display:block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    input, select, button { width: 100%; padding: 10px 12px; border-radius: 8px; border:1px solid var(--border); background:#0e1118; color:var(--text); }
    input[type="number"] { text-align: right; }
    button { cursor: pointer; background: #121624; transition: background .15s ease, transform .02s ease; }
    button:hover { background:#191e30; }
    .btn-row { display:flex; gap:10px; flex-wrap: wrap; }
    .btn { width:auto; }
    .btn-primary { background: var(--primary); border-color: transparent; color: #fff; }
    .btn-danger { background: var(--danger); border-color: transparent; color:#fff; }
    .row { display:flex; align-items: baseline; justify-content: space-between; gap:12px; }
    .kpi { font-size: 30px; font-weight: 700; }
    .muted-sm { color: var(--muted); font-size: 12px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; padding: 10px; border-bottom: 1px solid var(--border); }
    th { color: var(--muted); font-weight: 600; font-size: 12px; }
    .right { text-align: right; }
    .warn { color: #ffb86b; }
  </style>
</head>
<body>
  <div id="root" class="wrap"></div>

  <!-- React + Babel (no build tools) -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useMemo, useState } = React;

    // Utilities
    const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
    const fmtPct = x => !Number.isFinite(x) ? "–" : (x * 100).toFixed(2) + "%";
    const fmtMoney = x => !Number.isFinite(x) ? "–" : new Intl.NumberFormat(undefined, { style:"currency", currency:"EUR" }).format(x);

    function addMonths(date, months) {
      const d = new Date(date.getTime());
      const targetMonth = d.getMonth() + Number(months);
      const yearsToAdd = Math.floor(targetMonth / 12);
      const newMonth = targetMonth % 12;
      d.setFullYear(d.getFullYear() + yearsToAdd);
      d.setMonth(newMonth);
      return d;
    }

    function ClawbackCalculator() {
      // Inputs
      const [clientName, setClientName] = useState("");
      const [insurer, setInsurer] = useState("");
      const [contractNumber, setContractNumber] = useState("");

      const [commissionPaid, setCommissionPaid] = useState(0);
      const [responsibilityMonths, setResponsibilityMonths] = useState(12);
      const [startDate, setStartDate] = useState("");
      const [terminationDate, setTerminationDate] = useState("");
      const [mode, setMode] = useState("pro-rata-days"); // "whole-months-round-up" | "whole-months-round-down"

      // Saved rows
      const [rows, setRows] = useState([]);

      const result = useMemo(() => {
        if (!startDate || !terminationDate || !responsibilityMonths || responsibilityMonths <= 0) {
          return { valid:false, message:"Fill all required fields.", pct:0, repay:0 };
        }
        const start = new Date(startDate + "T00:00:00");
        const term = new Date(terminationDate + "T00:00:00");
        if (isNaN(start.getTime()) || isNaN(term.getTime())) return { valid:false, message:"Invalid dates.", pct:0, repay:0 };
        if (term < start) return { valid:false, message:"Termination cannot be before start.", pct:0, repay:0 };

        const end = addMonths(start, Number(responsibilityMonths));

        let earnedRatio = 0;
        if (mode === "pro-rata-days") {
          const totalDays = clamp((end - start) / 86400000, 1, Infinity);
          const elapsedDays = clamp((term - start) / 86400000, 0, totalDays);
          earnedRatio = clamp(elapsedDays / totalDays, 0, 1);
        } else if (mode === "whole-months-round-up") {
          let months = (term.getFullYear() - start.getFullYear()) * 12 + (term.getMonth() - start.getMonth());
          const partial = term.getDate() >= start.getDate() ? 0 : 1;
          months = months + (partial === 0 ? 1 : 0);
          months = clamp(months, 0, Number(responsibilityMonths));
          earnedRatio = months / Number(responsibilityMonths);
        } else {
          let months = (term.getFullYear() - start.getFullYear()) * 12 + (term.getMonth() - start.getMonth());
          if (term.getDate() < start.getDate()) months -= 1;
          months = clamp(months, 0, Number(responsibilityMonths));
          earnedRatio = months / Number(responsibilityMonths);
        }

        const pct = clamp(1 - earnedRatio, 0, 1);
        const repay = commissionPaid > 0 ? commissionPaid * pct : 0;
        return { valid:true, message:"", pct, repay };
      }, [commissionPaid, responsibilityMonths, startDate, terminationDate, mode]);

      const addRow = () => {
        if (!result.valid) return;
        const r = {
          name: clientName.trim(),
          insurer: insurer.trim(),
          contractNo: contractNumber.trim(),
          start: startDate,
          termination: terminationDate,
          months: Number(responsibilityMonths),
          method: mode,
          commissionPaid: Number(commissionPaid) || 0,
          clawbackPct: result.pct,
          repay: Number(result.repay) || 0
        };
        setRows(prev => [r, ...prev]);
      };

      const removeRow = (idx) => setRows(prev => prev.filter((_, i) => i !== idx));
      const clearRows = () => setRows([]);

      const exportCSV = () => {
        if (!rows.length) return;
        const headers = [
          "Name","Insurance Company","Contract Number","Start Date","Termination Date",
          "Responsibility Months","Counting Method","Commission Paid (€)","Clawback %","Repayment (€)"
        ];
        const mapMethod = m =>
          m === "pro-rata-days" ? "Pro-rata days" :
          m === "whole-months-round-up" ? "Whole months (up)" : "Whole months (down)";

        const csvRows = rows.map(r => [
          r.name, r.insurer, r.contractNo, r.start, r.termination, String(r.months), mapMethod(r.method),
          r.commissionPaid.toFixed(2), (r.clawbackPct*100).toFixed(2) + "%", r.repay.toFixed(2)
        ].map(v => `"${String(v).replaceAll('"','""')}"`).join(","));

        const csv = [headers.join(","), ...csvRows].join("\n");
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `clawbacks_${new Date().toISOString().slice(0,10)}.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      };

      const totalRepay = rows.reduce((s, r) => s + (Number(r.repay)||0), 0);

      return (
        <>
          <h1>Commission Clawback Calculator</h1>
          <p className="muted">Enter the initially paid commission, contract period and termination date to calculate the repayment amount. Save each calculation to build an exportable table.</p>

          <div className="card">
            <div className="grid grid-2">
              <div>
                <label htmlFor="clientName">Name</label>
                <input id="clientName" placeholder="e.g. Jane Doe" value={clientName} onChange={e => setClientName(e.target.value)} />
              </div>
              <div>
                <label htmlFor="insurer">Insurance Company</label>
                <input id="insurer" placeholder="e.g. Allianz" value={insurer} onChange={e => setInsurer(e.target.value)} />
              </div>
              <div>
                <label htmlFor="contractNumber">Contract number</label>
                <input id="contractNumber" placeholder="e.g. ABC-123456" value={contractNumber} onChange={e => setContractNumber(e.target.value)} />
              </div>

              <div>
                <label htmlFor="commissionPaid">Commission initially paid (€)</label>
                <input id="commissionPaid" type="number" min="0" step="0.01" placeholder="e.g. 3500"
                       value={commissionPaid} onChange={e => setCommissionPaid(Number(e.target.value || 0))} />
              </div>

              <div>
                <label htmlFor="months">Responsibility period (months)</label>
                <input id="months" type="number" min="1" step="1"
                       value={responsibilityMonths} onChange={e => setResponsibilityMonths(Number(e.target.value || 0))} />
              </div>

              <div>
                <label htmlFor="start">Contract start date</label>
                <input id="start" type="date" value={startDate} onChange={e => setStartDate(e.target.value)} />
              </div>

              <div>
                <label htmlFor="termination">Termination date</label>
                <input id="termination" type="date" value={terminationDate} onChange={e => setTerminationDate(e.target.value)} />
              </div>

              <div>
                <label htmlFor="method">Counting method</label>
                <select id="method" value={mode} onChange={e => setMode(e.target.value)}>
                  <option value="pro-rata-days">Pro-rata by days</option>
                  <option value="whole-months-round-up">Whole months (round up)</option>
                  <option value="whole-months-round-down">Whole months (round down)</option>
                </select>
                <div className="muted-sm">“Pro-rata by days” is usually fairest.</div>
              </div>

              {!result.valid && (
                <div className="warn">⚠ {result.message}</div>
              )}

              <div className="btn-row">
                <button className="btn" onClick={() => { setCommissionPaid(0); setResponsibilityMonths(12); setStartDate(""); setTerminationDate(""); setMode("pro-rata-days"); }}>Reset fields</button>
                <button className="btn btn-primary" onClick={addRow} disabled={!result.valid}>Add to table</button>
              </div>
            </div>
          </div>

          <div className="card">
            <div className="row">
              <div>
                <div className="muted-sm">Clawback percentage</div>
                <div className="kpi">{fmtPct(result.pct)}</div>
              </div>
              <div style={{textAlign:"right"}}>
                <div className="muted-sm">Repayment amount</div>
                <div className="kpi">{commissionPaid ? fmtMoney(result.repay) : "—"}</div>
              </div>
            </div>
          </div>

          <div className="card">
            <div className="row">
              <h2 style={{margin:0}}>Saved clawbacks ({rows.length})</h2>
              <div className="btn-row">
                <button className="btn" onClick={exportCSV} disabled={!rows.length}>Export CSV</button>
                <button className="btn btn-danger" onClick={clearRows} disabled={!rows.length}>Clear</button>
              </div>
            </div>
            <div style={{overflowX:"auto"}}>
              <table>
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Insurance Company</th>
                    <th>Contract #</th>
                    <th>Start</th>
                    <th>Termination</th>
                    <th>Months</th>
                    <th>Method</th>
                    <th className="right">Commission</th>
                    <th className="right">Clawback %</th>
                    <th className="right">Repay</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  {rows.length === 0 && (
                    <tr><td colSpan="11" className="muted-sm" style={{textAlign:"center", padding:"12px"}}>No entries yet. Calculate and click “Add to table”.</td></tr>
                  )}
                  {rows.map((r, i) => (
                    <tr key={i}>
                      <td>{r.name}</td>
                      <td>{r.insurer}</td>
                      <td>{r.contractNo}</td>
                      <td>{r.start}</td>
                      <td>{r.termination}</td>
                      <td>{r.months}</td>
                      <td>{r.method === "pro-rata-days" ? "Pro-rata days" : r.method === "whole-months-round-up" ? "Whole months (up)" : "Whole months (down)"}</td>
                      <td className="right">{fmtMoney(r.commissionPaid)}</td>
                      <td className="right">{fmtPct(r.clawbackPct)}</td>
                      <td className="right">{fmtMoney(r.repay)}</td>
                      <td className="right"><button className="btn" onClick={() => removeRow(i)}>Delete</button></td>
                    </tr>
                  ))}
                </tbody>
                {rows.length > 0 && (
                  <tfoot>
                    <tr>
                      <td colSpan="9" className="right">Total</td>
                      <td className="right">{fmtMoney(totalRepay)}</td>
                      <td></td>
                    </tr>
                  </tfoot>
                )}
              </table>
            </div>
          </div>
        </>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<ClawbackCalculator />);
  </script>
</body>
</html>
