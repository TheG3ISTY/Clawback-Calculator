import * as React from "react";
import { useMemo, useState } from "react";
import { Card, CardContent } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
import { Button } from "@/components/ui/button";
import { AlertCircle, Calendar, Calculator, DollarSign, PlusCircle, Trash2, FileDown } from "lucide-react";

// Types
interface CalcDetails {
  totalDays?: number;
  elapsedDays?: number;
  monthsCounted?: number;
  start?: Date;
  end?: Date;
}

interface CalcResult {
  valid: boolean;
  message: string;
  pct: number; // 0..1
  repay: number; // in EUR
  details: CalcDetails;
}

interface SavedRow {
  name: string;
  insurer: string;
  contractNo: string;
  start: string; // yyyy-mm-dd
  termination: string; // yyyy-mm-dd
  months: number;
  method: CountingMethod;
  commissionPaid: number;
  clawbackPct: number; // 0..1
  repay: number;
}

type CountingMethod = "pro-rata-days" | "whole-months-round-up" | "whole-months-round-down";

// Utils
function addMonths(date: Date, months: number): Date {
  const d = new Date(date.getTime());
  const targetMonth = d.getMonth() + months;
  const yearsToAdd = Math.floor(targetMonth / 12);
  const newMonth = targetMonth % 12;
  d.setFullYear(d.getFullYear() + yearsToAdd);
  d.setMonth(newMonth);
  return d;
}

function clamp(n: number, min: number, max: number): number {
  return Math.max(min, Math.min(max, n));
}

function formatPct(x: number): string {
  if (!Number.isFinite(x)) return "–";
  return (x * 100).toFixed(2) + "%";
}

function formatMoney(x: number): string {
  if (!Number.isFinite(x)) return "–";
  return new Intl.NumberFormat(undefined, { style: "currency", currency: "EUR" }).format(x);
}

export default function ClawbackCalculator(): JSX.Element {
  const [commissionPaid, setCommissionPaid] = useState<number>(0);
  const [responsibilityMonths, setResponsibilityMonths] = useState<number>(12);
  const [startDate, setStartDate] = useState<string>("");
  const [terminationDate, setTerminationDate] = useState<string>("");
  const [mode, setMode] = useState<CountingMethod>("pro-rata-days");

  // Free-text metadata fields
  const [clientName, setClientName] = useState<string>("");
  const [insurer, setInsurer] = useState<string>("");
  const [contractNumber, setContractNumber] = useState<string>("");

  // Table of saved clawbacks this session
  const [rows, setRows] = useState<SavedRow[]>([]);

  const result: CalcResult = useMemo(() => {
    if (!startDate || !terminationDate || !responsibilityMonths || responsibilityMonths <= 0) {
      return { valid: false, message: "Fill all required fields.", pct: 0, repay: 0, details: {} };
    }
    const start = new Date(startDate + "T00:00:00");
    const term = new Date(terminationDate + "T00:00:00");

    if (isNaN(start.getTime()) || isNaN(term.getTime())) {
      return { valid: false, message: "Invalid dates.", pct: 0, repay: 0, details: {} };
    }
    if (term < start) {
      return { valid: false, message: "Termination cannot be before start.", pct: 0, repay: 0, details: {} };
    }

    const end = addMonths(start, Number(responsibilityMonths));

    let earnedRatio = 0; // portion of commission earned and kept
    let detail: CalcDetails = {};

    if (mode === "pro-rata-days") {
      const totalDays = clamp((end.getTime() - start.getTime()) / (1000 * 60 * 60 * 24), 1, Infinity);
      const elapsedDays = clamp((term.getTime() - start.getTime()) / (1000 * 60 * 60 * 24), 0, totalDays);
      earnedRatio = clamp(elapsedDays / totalDays, 0, 1);
      detail = { totalDays: Math.round(totalDays), elapsedDays: Math.round(elapsedDays) };
    } else if (mode === "whole-months-round-up") {
      // Count months between start and termination, partial counts as full
      let months = (term.getFullYear() - start.getFullYear()) * 12 + (term.getMonth() - start.getMonth());
      const partial = term.getDate() >= start.getDate() ? 0 : 1; // if day earlier than start day, it's partial
      months = months + (partial === 0 ? 1 : 0); // include current month as full if not earlier day
      months = clamp(months, 0, Number(responsibilityMonths));
      earnedRatio = months / Number(responsibilityMonths);
      detail = { monthsCounted: months };
    } else if (mode === "whole-months-round-down") {
      // Count full months only, ignore partial
      let months = (term.getFullYear() - start.getFullYear()) * 12 + (term.getMonth() - start.getMonth());
      if (term.getDate() < start.getDate()) months -= 1; // not a full month yet
      months = clamp(months, 0, Number(responsibilityMonths));
      earnedRatio = months / Number(responsibilityMonths);
      detail = { monthsCounted: months };
    }

    const clawbackPct = clamp(1 - earnedRatio, 0, 1);
    const repay = commissionPaid > 0 ? commissionPaid * clawbackPct : 0;

    return { valid: true, message: "", pct: clawbackPct, repay, details: { ...detail, start, end } };
  }, [commissionPaid, responsibilityMonths, startDate, terminationDate, mode]);

  const pct = result.pct ?? 0;

  function addRow() {
    if (!result.valid) return;
    const row: SavedRow = {
      name: clientName || "",
      insurer: insurer || "",
      contractNo: contractNumber || "",
      start: startDate,
      termination: terminationDate,
      months: Number(responsibilityMonths),
      method: mode,
      commissionPaid: Number(commissionPaid) || 0,
      clawbackPct: pct,
      repay: Number(result.repay) || 0,
    };
    setRows(prev => [row, ...prev]);
  }

  function removeRow(index: number) {
    setRows(prev => prev.filter((_, i) => i !== index));
  }

  function clearRows() {
    setRows([]);
  }

  function exportCSV() {
    if (!rows.length) return;
    const headers = [
      "Name",
      "Insurance Company",
      "Contract Number",
      "Start Date",
      "Termination Date",
      "Responsibility Months",
      "Counting Method",
      "Commission Paid (€)",
      "Clawback %",
      "Repayment (€)"
    ];

    const mapMethod = (m: CountingMethod) => (
      m === "pro-rata-days" ? "Pro‑rata days" : m === "whole-months-round-up" ? "Whole months (up)" : "Whole months (down)"
    );

    const rowsCsv = rows.map(r => [
      r.name,
      r.insurer,
      r.contractNo,
      r.start,
      r.termination,
      String(r.months),
      mapMethod(r.method),
      r.commissionPaid.toFixed(2),
      (r.clawbackPct * 100).toFixed(2) + "%",
      r.repay.toFixed(2)
    ].map(v => `"${String(v).replaceAll('"','""')}"`).join(","));

    const csv = [headers.join(","), ...rowsCsv].join("\n");
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `clawbacks_${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  const totalRepay = rows.reduce((sum, r) => sum + (Number(r.repay) || 0), 0);

  return (
    <div className="min-h-screen w-full bg-background text-foreground px-4 py-8 lg:py-12">
      <div className="max-w-5xl mx-auto space-y-6">
        <header className="space-y-2">
          <h1 className="text-2xl sm:text-3xl font-semibold tracking-tight">Commission Clawback Calculator</h1>
          <p className="text-sm text-muted-foreground">Enter the initially paid commission, contract period and termination date to calculate the repayment amount. Save each calculation to build an exportable table.</p>
        </header>

        <Card className="shadow-sm border">
          <CardContent className="p-4 sm:p-6 grid grid-cols-1 md:grid-cols-2 gap-4">
            <div className="space-y-2">
              <Label htmlFor="clientName">Name</Label>
              <Input id="clientName" placeholder="e.g. Jane Doe" value={clientName} onChange={(e: React.ChangeEvent<HTMLInputElement>) => setClientName(e.target.value)} />
            </div>
            <div className="space-y-2">
              <Label htmlFor="insurer">Insurance Company</Label>
              <Input id="insurer" placeholder="e.g. Allianz" value={insurer} onChange={(e: React.ChangeEvent<HTMLInputElement>) => setInsurer(e.target.value)} />
            </div>
            <div className="space-y-2 md:col-span-2">
              <Label htmlFor="contractNumber">Contract number</Label>
              <Input id="contractNumber" placeholder="e.g. ABC-123456" value={contractNumber} onChange={(e: React.ChangeEvent<HTMLInputElement>) => setContractNumber(e.target.value)} />
            </div>

            <div className="space-y-2">
              <Label htmlFor="commissionPaid">Commission initially paid (€)</Label>
              <div className="flex items-center gap-2">
                <DollarSign className="h-4 w-4 opacity-50" />
                <Input id="commissionPaid" type="number" min={0} step={0.01} placeholder="e.g. 3500" value={commissionPaid} onChange={(e: React.ChangeEvent<HTMLInputElement>) => setCommissionPaid(Number(e.target.value || 0))} />
              </div>
            </div>

            <div className="space-y-2">
              <Label htmlFor="months">Responsibility period (months)</Label>
              <div className="flex items-center gap-2">
                <Calculator className="h-4 w-4 opacity-50" />
                <Input id="months" type="number" min={1} step={1} value={responsibilityMonths} onChange={(e: React.ChangeEvent<HTMLInputElement>) => setResponsibilityMonths(Number(e.target.value || 0))} />
              </div>
            </div>

            <div className="space-y-2">
              <Label htmlFor="start">Contract start date</Label>
              <div className="flex items-center gap-2">
                <Calendar className="h-4 w-4 opacity-50" />
                <Input id="start" type="date" value={startDate} onChange={(e: React.ChangeEvent<HTMLInputElement>) => setStartDate(e.target.value)} />
              </div>
            </div>

            <div className="space-y-2">
              <Label htmlFor="termination">Termination date</Label>
              <div className="flex items-center gap-2">
                <Calendar className="h-4 w-4 opacity-50" />
                <Input id="termination" type="date" value={terminationDate} onChange={(e: React.ChangeEvent<HTMLInputElement>) => setTerminationDate(e.target.value)} />
              </div>
            </div>

            <div className="space-y-2 md:col-span-2">
              <Label>Counting method</Label>
              <Select value={mode} onValueChange={(value: CountingMethod) => setMode(value)}>
                <SelectTrigger>
                  <SelectValue placeholder="Select rounding method" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="pro-rata-days">Pro‑rata by days</SelectItem>
                  <SelectItem value="whole-months-round-up">Whole months (round up)</SelectItem>
                  <SelectItem value="whole-months-round-down">Whole months (round down)</SelectItem>
                </SelectContent>
              </Select>
              <p className="text-xs text-muted-foreground">"Pro‑rata by days" is usually fairest. Switch if your agreement uses a different rule.</p>
            </div>

            {!result.valid && (
              <div className="md:col-span-2 text-sm text-red-600 flex items-center gap-2"><AlertCircle className="h-4 w-4"/> {result.message}</div>
            )}

            <div className="md:col-span-2 flex flex-wrap gap-2 pt-2">
              <Button variant="outline" onClick={() => { setCommissionPaid(0); setResponsibilityMonths(12); setStartDate(""); setTerminationDate(""); setMode("pro-rata-days"); }}>Reset fields</Button>
              <Button onClick={addRow} disabled={!result.valid}><PlusCircle className="h-4 w-4 mr-1"/>Add to table</Button>
            </div>
          </CardContent>
        </Card>

        {/* Live result summary */}
        <Card className="shadow-sm border">
          <CardContent className="p-4 sm:p-6 space-y-4">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-xs uppercase tracking-wider text-muted-foreground">Clawback percentage</p>
                <h2 className="text-3xl font-semibold">{formatPct(pct)}</h2>
              </div>
              <div className="text-right">
                <p className="text-xs uppercase tracking-wider text-muted-foreground">Repayment amount</p>
                <h2 className="text-2xl font-semibold">{commissionPaid ? formatMoney(result.repay) : "—"}</h2>
              </div>
            </div>

            <div className="w-full bg-muted h-3 rounded-full overflow-hidden" aria-label="progress">
              <div className="h-3 bg-primary" style={{ width: `${pct * 100}%` }} />
            </div>
          </CardContent>
        </Card>

        {/* Saved table */}
        <Card className="shadow-sm border">
          <CardContent className="p-4 sm:p-6 space-y-4">
            <div className="flex items-center justify-between">
              <h2 className="text-lg font-semibold">Saved clawbacks ({rows.length})</h2>
              <div className="flex gap-2">
                <Button variant="outline" onClick={exportCSV} disabled={!rows.length}><FileDown className="h-4 w-4 mr-1"/>Export CSV</Button>
                <Button variant="destructive" onClick={clearRows} disabled={!rows.length}><Trash2 className="h-4 w-4 mr-1"/>Clear</Button>
              </div>
            </div>

            <div className="overflow-x-auto">
              <table className="w-full text-sm">
                <thead className="text-left text-muted-foreground">
                  <tr>
                    <th className="py-2 pr-2">Name</th>
                    <th className="py-2 pr-2">Insurance Company</th>
                    <th className="py-2 pr-2">Contract #</th>
                    <th className="py-2 pr-2">Start</th>
                    <th className="py-2 pr-2">Termination</th>
                    <th className="py-2 pr-2">Months</th>
                    <th className="py-2 pr-2">Method</th>
                    <th className="py-2 pr-2">Commission</th>
                    <th className="py-2 pr-2">Clawback %</th>
                    <th className="py-2 pr-2">Repay</th>
                    <th className="py-2 pr-2" />
                  </tr>
                </thead>
                <tbody>
                  {rows.length === 0 && (
                    <tr>
                      <td colSpan={11} className="py-4 text-center text-muted-foreground">No entries yet. Calculate and click "Add to table".</td>
                    </tr>
                  )}
                  {rows.map((r, i) => (
                    <tr key={i} className="border-t">
                      <td className="py-2 pr-2">{r.name}</td>
                      <td className="py-2 pr-2">{r.insurer}</td>
                      <td className="py-2 pr-2">{r.contractNo}</td>
                      <td className="py-2 pr-2">{r.start}</td>
                      <td className="py-2 pr-2">{r.termination}</td>
                      <td className="py-2 pr-2">{r.months}</td>
                      <td className="py-2 pr-2">{r.method === "pro-rata-days" ? "Pro‑rata days" : r.method === "whole-months-round-up" ? "Whole months (up)" : "Whole months (down)"}</td>
                      <td className="py-2 pr-2">{formatMoney(r.commissionPaid)}</td>
                      <td className="py-2 pr-2">{formatPct(r.clawbackPct)}</td>
                      <td className="py-2 pr-2">{formatMoney(r.repay)}</td>
                      <td className="py-2 pr-2 text-right">
                        <Button size="sm" variant="ghost" onClick={() => removeRow(i)}><Trash2 className="h-4 w-4"/></Button>
                      </td>
                    </tr>
                  ))}
                </tbody>
                {rows.length > 0 && (
                  <tfoot>
                    <tr className="border-t font-medium">
                      <td colSpan={9} className="py-2 pr-2 text-right">Total</td>
                      <td className="py-2 pr-2">{formatMoney(totalRepay)}</td>
                      <td />
                    </tr>
                  </tfoot>
                )}
              </table>
            </div>
          </CardContent>
        </Card>

        <section className="text-xs text-muted-foreground leading-relaxed">
          <p className="mb-2"><strong>Assumptions:</strong> Clawback equals the unearned portion within the responsibility window. After the window ends, clawback is 0%. Before it begins, clawback is 100%.</p>
          <p><strong>Tip:</strong> Save each scenario to the table, then export CSV at the end. CSV opens in Excel, Numbers, LibreOffice and Google Sheets. If you need native .xlsx, wire a client-side generator like SheetJS later.</p>
        </section>
      </div>
    </div>
  );
}
